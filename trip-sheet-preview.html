<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Sheet - Print Preview</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            color-adjust: exact;
        }

        body {
            font-family: 'Courier New', monospace;
            background: white;
            color: black;
            padding: 0.5in;
            line-height: 1.2;
        }

        /* Buttons */
        .no-print {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 9999;
        }

        .no-print button {
            padding: 8px 16px;
            background: #0077cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-family: sans-serif;
        }

        .no-print button:hover {
            background: #005fa3;
        }

        /* Driver Name Header */
        .driver-header {
            text-align: center;
            font-size: 32pt;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 2px solid #0077cc;
            padding-bottom: 5px;
        }

        /* Main tables */
        .main-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            border: 3px solid black;
        }

        .main-table th {
            background-color: #5e9868;
            color: #000000;
            font-size: 16pt;
            font-weight: bold;
            padding: 8px;
            text-align: center;
            border: 2px solid black;
        }

        .main-table td {
            background-color: #d7e4d8;
            color: #000000;
            font-size: 16pt;
            font-weight: bold;
            padding: 8px;
            text-align: center;
            border: 2px solid black;
        }

        /* Stops table */
        .stops-header {
            text-align: center;
            font-size: 24pt;
            font-weight: bold;
            margin: 25px 0 10px 0;
            text-decoration: underline;
        }

        .stops-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            border: 3px solid black;
        }

        .stops-table th {
            background-color: #5e9868;
            color: #000000;
            font-size: 16pt;
            font-weight: bold;
            padding: 8px;
            text-align: center;
            border: 2px solid black;
        }

        .stops-table td {
            background-color: #d7e4d8;
            color: #000000;
            font-size: 16pt;
            font-weight: bold;
            padding: 8px;
            text-align: center;
            border: 2px solid black;
        }

        .stops-table td.location {
            text-align: left;
            padding-left: 15px;
        }

        /* Notes section */
        .notes-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border: 3px solid black;
        }

        .notes-table th {
            background-color: #5e9868;
            color: #000000;
            font-size: 16pt;
            font-weight: bold;
            padding: 10px;
            text-align: center;
            border: 2px solid black;
        }

        .notes-table td {
            background-color: #d7e4d8;
            color: #000000;
            font-size: 14pt;
            font-weight: bold;
            padding: 10px;
            text-align: left;
            border: 2px solid black;
        }

        /* Drop crew table */
        .drop-crew-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border: 3px solid black;
        }

        .drop-crew-table th {
            background-color: #5e9868;
            color: #000000;
            font-size: 16pt;
            font-weight: bold;
            padding: 8px;
            text-align: center;
            border: 2px solid black;
        }

        .drop-crew-table td {
            background-color: #d7e4d8;
            color: #000000;
            font-size: 16pt;
            font-weight: bold;
            padding: 8px;
            text-align: center;
            border: 2px solid black;
        }

        .drop-crew-table .blue-bg {
            background-color: #6a91b8;
            color: #000000;
        }

        /* Keys section */
        .keys {
            font-size: 10pt;
            text-align: center;
            margin: 10px 0;
            line-height: 1.4;
        }

        .keys .key {
            display: inline-block;
            margin: 0 5px;
        }

        @media print {
            body {
                padding: 0.5in;
            }

            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="no-print">
        <button onclick="downloadPDF()">Download PDF</button>
        <button onclick="window.close()">Close</button>
    </div>

    <div class="trip-sheet">
        <!-- Driver Name Header -->
        <div class="driver-header" id="previewDriverName">DRIVER NAME</div>

        <!-- Table 1: Trip Date, Type, Van ID -->
        <table class="main-table">
            <tr>
                <th>TRIP DATE</th>
                <th>TRIP TYPE</th>
                <th>VAN ID</th>
            </tr>
            <tr>
                <td id="previewTripDate">-</td>
                <td id="previewTripType">-</td>
                <td id="previewVanId">-</td>
            </tr>
        </table>

        <!-- Table 2: RR #, Hallcon # -->
        <table class="main-table">
            <tr>
                <th>RR #</th>
                <th>Hallcon #</th>
            </tr>
            <tr>
                <td id="previewRrNumber">-</td>
                <td id="previewHallconNumber">-</td>
            </tr>
        </table>

        <!-- Table 3: Names, To, Disp # -->
        <table class="main-table">
            <tr>
                <th>Name(s)</th>
                <th>To?</th>
                <th>Disp #</th>
            </tr>
            <tr>
                <td id="previewCrewNames">-</td>
                <td id="previewDestination">-</td>
                <td id="previewDispatcher">-</td>
            </tr>
        </table>

        <!-- Stops Section -->
        <div class="stops-header">STOPS WITH CREW</div>
        <table class="stops-table" id="stopsTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>TIMES</th>
                    <th>LOCATION</th>
                    <th>ODOMETER</th>
                    <th>WHY?</th>
                    <th>MINS</th>
                </tr>
            </thead>
            <tbody id="previewStopsBody">
            </tbody>
        </table>

        <!-- Keys -->
        <div class="keys">
            <div class="key"><strong>LOCATION ABBREVIATION KEY:</strong></div><br>
            <div class="key">Y.O.: Yard Office</div>
            <div class="key">Clarks: Clarksville</div>
            <div class="key">Russ: Russellville</div>
            <div class="key">LNGVW: Longview</div>
            <div class="key">V.B.: Van Buren</div>
            <div class="key">P.B.: Pine Bluff</div>
            <div class="key">POP.B: Poplar Bluff</div>
        </div>
        <div class="keys">
            <div class="key"><strong>STOP REASON KEY (5th Column):</strong></div><br>
            <div class="key">PU: PICKUP</div>
            <div class="key">CS: CREW STOP</div>
            <div class="key">SC: SWAP CREW</div>
            <div class="key">W8: WAIT</div>
            <div class="key">DC: DROP CREW</div>
        </div>

        <!-- Notes Section -->
        <table class="notes-table">
            <tr>
                <th>NOTES/APPROVALS</th>
            </tr>
            <tr>
                <td id="previewNotes">-</td>
            </tr>
        </table>

        <!-- Drop Crew Table -->
        <table class="drop-crew-table">
            <tr>
                <th class="blue-bg">DROP CREW TIME</th>
                <th class="blue-bg">DROP CREW ODOMETER</th>
            </tr>
            <tr>
                <td id="previewDropCrewTime">-</td>
                <td id="previewEndOdometer">-</td>
            </tr>
            <tr>
                <th class="blue-bg">TOTAL WAIT</th>
                <th class="blue-bg">TOTAL MILES</th>
            </tr>
            <tr>
                <td id="previewTotalWait">0</td>
                <td id="previewTotalMiles">0</td>
            </tr>
            <tr>
                <th class="blue-bg">Clock In (Van PU Time)</th>
                <th class="blue-bg">Clock Out (Van DO Time)</th>
            </tr>
            <tr>
                <td id="previewClockIn">-</td>
                <td id="previewClockOut">-</td>
            </tr>
        </table>
    </div>

    <script>
        function loadPreview() {
            const raw = localStorage.getItem('lastTrip');
            if (!raw) {
                document.body.innerHTML = `
                    <div style="text-align: center; padding: 50px; font-family: sans-serif;">
                        <h2>No trip data found</h2>
                        <p>Please create a trip first in the main app.</p>
                        <button onclick="window.close()" style="padding: 10px 20px; margin-top: 20px;">Close</button>
                    </div>
                `;
                return;
            }

            try {
                const trip = JSON.parse(raw);

                // Driver name in header
                document.getElementById('previewDriverName').textContent = trip.driverName || 'DRIVER NAME';

                // Top table
                document.getElementById('previewTripDate').textContent = trip.tripdate || '-';
                document.getElementById('previewTripType').textContent = trip.tripType || '-';
                document.getElementById('previewVanId').textContent = trip.vanID || '-';

                // Second table
                document.getElementById('previewRrNumber').textContent = trip.rrNumber || '-';
                document.getElementById('previewHallconNumber').textContent = trip.hallconNumber || '-';

                // Third table
                document.getElementById('previewCrewNames').textContent = trip.crewNames || '-';
                document.getElementById('previewDestination').textContent = trip.destination || '-';
                document.getElementById('previewDispatcher').textContent = trip.dispatcher || '-';

                // Stops table
                const stopsBody = document.getElementById('previewStopsBody');
                stopsBody.innerHTML = '';

                if (trip.stops && trip.stops.length > 0) {
                    trip.stops.forEach(stop => {
                        const row = stopsBody.insertRow();
                        row.innerHTML = `
                            <td>${stop.index || '-'}</td>
                            <td>${stop.times || ''}</td>
                            <td class="location">${stop.location || ''}</td>
                            <td>${stop.odometer || ''}</td>
                            <td>${stop.why || ''}</td>
                            <td>${stop.wait || '0'}</td>
                        `;
                    });
                } else {
                    const row = stopsBody.insertRow();
                    row.innerHTML = '<td colspan="6" style="padding: 15px;">No stops recorded</td>';
                }

                // Notes
                document.getElementById('previewNotes').textContent = trip.notes || '-';

                // Drop crew section
                document.getElementById('previewDropCrewTime').textContent = trip.dropcrewTime || '-';
                document.getElementById('previewEndOdometer').textContent = trip.dropcrewOdometer || '-';
                document.getElementById('previewTotalWait').textContent = trip.totalWait || '0';
                document.getElementById('previewTotalMiles').textContent = trip.totalMiles || '0';
                document.getElementById('previewClockIn').textContent = trip.clockInTime || '-';
                document.getElementById('previewClockOut').textContent = trip.clockOutTime || '-';

            } catch (error) {
                console.error('Preview error:', error);
                alert('Error loading preview: ' + error.message);
            }
        }

        function downloadPDF() {
            const raw = localStorage.getItem('lastTrip');
            let filename = 'trip-sheet.pdf';

            if (raw) {
                try {
                    const trip = JSON.parse(raw);
                    const rrNumber = trip.rrNumber || 'trip-sheet';
                    filename = rrNumber.replace(/[^a-z0-9\-_]/gi, '') + '.pdf';
                } catch (e) {
                    console.error('Error parsing RR number:', e);
                }
            }

            document.title = filename.replace('.pdf', '');
            window.print();
        }

        window.onload = loadPreview;
    </script>
</body>
</html>