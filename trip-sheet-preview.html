<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Sheet - Print Preview</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="preview-page">
    <div class="no-print">
        <button onclick="downloadPDF()">Download PDF</button>
        <button onclick="window.close()">Close</button>
    </div>

    <div class="trip-sheet">
        <h1>OFFICIAL TRIP SHEET</h1>
        
        <!-- DRIVER INFO -->
        <h3>Driver Info</h3>
        <div class="grid-4">
            <div>
                <div class="field-label">Driver Name</div>
                <div class="field-value" id="previewDriverName">-</div>
            </div>
            <div>
                <div class="field-label">Trip Date</div>
                <div class="field-value" id="previewTripDate">-</div>
            </div>
            <div>
                <div class="field-label">Van Id</div>
                <div class="field-value" id="previewVanId">-</div>
            </div>
            <div>
                <div class="field-label">Start Odometer</div>
                <div class="field-value" id="previewStartOdometer">-</div>
            </div>
        </div>
        
        <!-- CREW INFO -->
        <h3>Crew Info</h3>
        <div class="grid-3">
            <div>
                <div class="field-label">RR #</div>
                <div class="field-value" id="previewRrNumber">-</div>
            </div>
            <div>
                <div class="field-label">Hallcon #</div>
                <div class="field-value" id="previewHallconNumber">-</div>
            </div>
            <div>
                <div class="field-label">Crew Names</div>
                <div class="field-value" id="previewCrewNames">-</div>
            </div>
            <div>
                <div class="field-label">Trip Type</div>
                <div class="field-value" id="previewTripType">-</div>
            </div>
            <div>
                <div class="field-label">Destination</div>
                <div class="field-value" id="previewDestination">-</div>
            </div>
            <div>
                <div class="field-label">Dispatcher</div>
                <div class="field-value" id="previewDispatcher">-</div>
            </div>
        </div>
        
        <!-- STOPS W/ CREW -->
        <h3>Stops W/ Crew</h3>
        <table id="previewStopsTable">
            <thead>
                <tr>
                    <th width="5%">#</th>
                    <th width="25%">TIMES</th>
                    <th width="35%">LOCATION</th>
                    <th width="15%">ODOMETER</th>
                    <th width="8%">WHY</th>
                    <th width="12%">WAIT</th>
                </tr>
            </thead>
            <tbody id="previewStopsBody">
                <!-- Stops will be inserted here -->
            </tbody>
        </table>
        
        <!-- NOTES (part of Stops section) -->
        <div class="notes-section">
            <div class="field-label" style="text-align: left;">NOTES</div>
            <div class="notes-content" id="previewNotes"></div>
        </div>
        
        <!-- DROP CREW SECTION -->
        <h3>Drop Crew Section</h3>
        <div class="grid-4">
            <div>
                <div class="field-label">DoC Time</div>
                <div class="field-value" id="previewDropCrewTime">-</div>
            </div>
            <div>
                <div class="field-label">DoC Odometer</div>
                <div class="field-value" id="previewEndOdometer">-</div>
            </div>
            <div>
                <div class="field-label">Total Wait</div>
                <div class="field-value" id="previewTotalWait">0</div>
            </div>
            <div>
                <div class="field-label">Total Miles</div>
                <div class="field-value" id="previewTotalMiles">0</div>
            </div>
        </div>
        
        <!-- TIME CLOCK -->
        <h3>Time Clock</h3>
        <div class="grid-centered">
            <div></div>
            <div>
                <div class="field-label">Clock In Time</div>
                <div class="field-value" id="previewClockIn">-</div>
            </div>
            <div>
                <div class="field-label">Clock Out Time</div>
                <div class="field-value" id="previewClockOut">-</div>
            </div>
            <div></div>
        </div>
    </div>

    <script>
        function loadPreview() {
            const raw = localStorage.getItem('lastTrip');
            if (!raw) {
                document.body.innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <h2>No trip data found</h2>
                        <p>Please create a trip first in the main app.</p>
                        <button onclick="window.close()" style="padding: 10px 20px; margin-top: 20px;">Close</button>
                    </div>
                `;
                return;
            }
            
            try {
                const trip = JSON.parse(raw);
                
                // Basic info
                document.getElementById('previewDriverName').textContent = trip.driverName || '-';
                document.getElementById('previewTripDate').textContent = trip.tripdate || '-';
                document.getElementById('previewVanId').textContent = trip.vanID || '-';
                document.getElementById('previewTripType').textContent = trip.tripType || '-';
                
                // Trip details
                document.getElementById('previewRrNumber').textContent = trip.rrNumber || '-';
                document.getElementById('previewHallconNumber').textContent = trip.hallconNumber || '-';
                document.getElementById('previewDispatcher').textContent = trip.dispatcher || '-';
                document.getElementById('previewCrewNames').textContent = trip.crewNames || '-';
                document.getElementById('previewDestination').textContent = trip.destination || '-';
                document.getElementById('previewStartOdometer').textContent = trip.startOdometer || '-';
                
                // End of trip
                document.getElementById('previewEndOdometer').textContent = trip.dropcrewOdometer || '-';
                document.getElementById('previewDropCrewTime').textContent = trip.dropcrewTime || '-';
                document.getElementById('previewClockIn').textContent = trip.clockInTime || '-';
                document.getElementById('previewClockOut').textContent = trip.clockOutTime || '-';
                
                // Totals
                document.getElementById('previewTotalMiles').textContent = trip.totalMiles || '0';
                document.getElementById('previewTotalWait').textContent = trip.totalWait || '0';
                
                // Notes
                document.getElementById('previewNotes').textContent = trip.notes || 'No notes recorded';
                
                // Stops table
                const stopsBody = document.getElementById('previewStopsBody');
                stopsBody.innerHTML = '';
                
                if (trip.stops && trip.stops.length > 0) {
                    trip.stops.forEach(stop => {
                        const row = stopsBody.insertRow();
                        row.innerHTML = `
                            <td style="text-align: center; font-weight: bold;">${stop.index || '-'}</td>
                            <td style="text-align: center;">${stop.times || ''}</td>
                            <td style="text-align: left; padding-left: 15px;">${stop.location || ''}</td>
                            <td style="text-align: center;">${stop.odometer || ''}</td>
                            <td style="text-align: center;">${stop.why || ''}</td>
                            <td style="text-align: center;">${stop.wait || '0'}</td>
                        `;
                    });
                } else {
                    const row = stopsBody.insertRow();
                    row.innerHTML = '<td colspan="6" style="text-align: center; padding: 20px;">No stops recorded</td>';
                }
                
            } catch (error) {
                console.error('Preview error:', error);
                alert('Error loading preview: ' + error.message);
            }
        }
        
        function downloadPDF() {
            const raw = localStorage.getItem('lastTrip');
            let filename = 'trip-sheet.pdf';
            
            if (raw) {
                try {
                    const trip = JSON.parse(raw);
                    const rrNumber = trip.rrNumber || 'trip-sheet';
                    filename = rrNumber.replace(/[^a-z0-9\-_]/gi, '') + '.pdf';
                } catch (e) {
                    console.error('Error parsing RR number:', e);
                }
            }
            
            // Update document title for print dialog
            document.title = filename.replace('.pdf', '');
            
            // Trigger print dialog (user can save as PDF)
            window.print();
        }
        
        window.onload = loadPreview;
    </script>
</body>
</html>
